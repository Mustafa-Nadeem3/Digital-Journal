<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Logo Link -->
  <link rel="icon" href="/images/logo.png" />
  <title>Chronicle Keeper</title>
  <!-- Bootstrap CSS Link -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
  <!-- Font Awesome Icons Link -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css">
  <!-- Font Style Link -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet">
  <!-- My CSS Link -->
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <!-- SideMenu Section -->
  <section id="side-menu">
    <div class="container">
      <div class="row">
        <div class="col-12">
          <h2 class="text-primary fw-bold text-center p-3" id="name"></h2>
          <div class="col-12 p-3 dashlink mb-2 shadow">
            <a href="/dashboard.html" class="text-decoration-none"><i
                class="fa-solid fa-book-open me-2"></i>Dashboard</a>
          </div>
          <div class="col-12 p-3 dashlink mb-2 shadow">
            <a href="/to-do.html" class="text-decoration-none"><i class="fa-solid fa-list-check me-2"></i>To-Do</a>
          </div>
          <div class="col-12 p-3 dashlink mb-2 shadow">
            <a href="/journal.html" class="text-decoration-none"><i class="fa-solid fa-book me-2"></i>Journal</a>
          </div>
          <div class="col-12 p-3 activelink mb-2 shadow">
            <a href="/password.html" class="text-decoration-none"><i class="fa-solid fa-lock me-2"></i>Password</a>
          </div>
          <div class="col-12 p-3 logoutlink shadow">
            <a href="/index.html" class="text-decoration-none"><i
                class="fa-solid fa-arrow-right-from-bracket me-2"></i>Close Book</a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Dashboard Section -->
  <section id="dashboard">
    <div class="container">
      <div class="row mt-2">
        <div class="col-12 mobile_navbar">
          <div class="d-flex justify-content-start align-items-center">
            <h1 class="fw-bold text-primary me-3 pt-2">Password</h1>
            <button class="bg-secondary border-3 border border-primary rounded-circle" type="button"
              data-bs-toggle="offcanvas" data-bs-target="#offcanvasExample" aria-controls="offcanvasExample">
              <i class="fa-solid fa-bars"></i>
            </button>
          </div>
          <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasExample"
            aria-labelledby="offcanvasExampleLabel">
            <div class="offcanvas-header justify-content-end">
              <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
              <div class="dropdown mt-3">
                <h2 class="text-primary fw-bold text-center p-3" id="name"></h2>
                <div class="col-12 p-3 dashlink mb-2 shadow">
                  <a href="/dashboard.html" class="text-decoration-none"><i
                      class="fa-solid fa-book-open me-2"></i>Dashboard</a>
                </div>
                <div class="col-12 p-3 dashlink mb-2 shadow">
                  <a href="/to-do.html" class="text-decoration-none"><i
                      class="fa-solid fa-list-check me-2"></i>To-Do</a>
                </div>
                <div class="col-12 p-3 dashlink mb-2 shadow">
                  <a href="/journal.html" class="text-decoration-none"><i class="fa-solid fa-book me-2"></i>Journal</a>
                </div>
                <div class="col-12 p-3 activelink mb-2 shadow">
                  <a href="/password.html" class="text-decoration-none"><i
                      class="fa-solid fa-lock me-2"></i>Password</a>
                </div>
                <div class="col-12 p-3 logoutlink shadow">
                  <a href="/index.html" class="text-decoration-none"><i
                      class="fa-solid fa-arrow-right-from-bracket me-2"></i>Close Book</a>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 d-flex justify-content-center align-items-center mobile-page">
          <div class="col-lg-6 col-sm-12 book page shadow">
            <div class="row left-page shadow">
              <div class="col-12 left-page-1 shadow text-center p-5">
                <form action="">
                  <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="email" placeholder="name@example.com">
                    <label for="email">Email address/Username</label>
                  </div>
                  <div class="form-floating mb-3">
                    <input type="password" class="form-control" id="password" placeholder="Password">
                    <label for="password">Password</label>
                  </div>
                  <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="key" placeholder="Key">
                    <label for="key">Decrypt Key</label>
                  </div>
                  <div class="d-flex justify-content-center">
                    <button id="submit" type="submit"
                      class="border border-2 border-primary rounded-pill px-3 py-2 bg-secondary text-primary fw-bold">Add</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <div class="col-lg-6 col-sm-12 book page shadow">
            <div class="row right-page shadow">
              <div class="col-12 right-page-1 shadow p-5 justify-content-center align-items-center">
                <div id="account">

                </div>

                <div id="show" data-bs-toggle="modal" data-bs-target="#exampleModal">

                </div>

                <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel"
                  aria-hidden="true">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">Please Provide Your Password</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <div class="form-floating mb-3">
                          <input type="password" class="form-control" id="keyPassword" placeholder="Password">
                          <label for="keyPassword">Password</label>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button id="getPassword" type="button" class="btn btn-primary" data-bs-dismiss="modal">Get
                          Password</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Bootstrap JS Link -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
    crossorigin="anonymous"></script>
  <!-- Crypto JS Link -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <!-- My JS Link -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js"
    import { getDatabase, ref, set, push, get } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-database.js"

    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyDMn2keSNKTwhA41-7ApI_iWckrLNJYvgM",
      authDomain: "chronicle-keeper-92380.firebaseapp.com",
      databaseURL: "https://chronicle-keeper-92380-default-rtdb.firebaseio.com",
      projectId: "chronicle-keeper-92380",
      storageBucket: "chronicle-keeper-92380.appspot.com",
      messagingSenderId: "830785207681",
      appId: "1:830785207681:web:0ae18b9db8f147ee5cfc80",
      measurementId: "G-WRH64WKX1W"
    }

    // Initialize Firebase
    const app = initializeApp(firebaseConfig)
    const db = getDatabase(app)

    document.getElementById("name").innerHTML = localStorage.getItem('currentUserName')

    const passwordRef = ref(db, 'password')
    const newPasswordRef = push(passwordRef)

    document.getElementById("submit").addEventListener('click', function (e) {
      e.preventDefault()

      const password = document.getElementById("password").value
      const key = document.getElementById("key").value

      const encryptPassword = CryptoJS.AES.encrypt(password, key).toString()

      set(newPasswordRef, {
        userId: localStorage.getItem('currentUserId'),
        email: document.getElementById("email").value,
        password: encryptPassword
      })
        .then(() => {
          alert("Password Successfully Add !")
          window.location.href = "/password.html"
        })
        .catch((error) => {
          console.error("Error adding password: ", error)
        })
    })

    let btn_click = false

    document.getElementById("show").addEventListener('click', function (e) {
      e.preventDefault()

      const showButton = document.getElementById("showPassword")

      if (showButton.textContent === 'Show password' && btn_click == false) {
        btn_click = true
      } else if (btn_click == true) {
        btn_click = false
        showButton.textContent = 'Show password'
      }
    })

    document.getElementById("getPassword").addEventListener('click', function (e) {
      e.preventDefault()

      const showButton = document.getElementById("showPassword")

      get(passwordRef)
        .then((snapshot) => {
          if (snapshot.exists()) {
            const passwordCount = Object.keys(snapshot.val()).length
            for (let i = 0; i < passwordCount; i++) {
              const userId = Object.keys(snapshot.val())[i]
              const passwordData = snapshot.val()[userId]

              if (localStorage.getItem('currentUserId') == passwordData.userId) {
                const encryptPassword = passwordData.password
                const key = document.getElementById("keyPassword").value
                const decryptBytes = CryptoJS.AES.decrypt(encryptPassword, key)
                const decryptPassword = decryptBytes.toString(CryptoJS.enc.Utf8)
                showButton.textContent = decryptPassword
              }
            }
          } else {
            console.log("No data available")
          }
        })
        .catch((error) => {
          console.error("Error retrieving data:", error)
        })
    })

    get(passwordRef)
      .then((snapshot) => {
        if (snapshot.exists()) {
          const passwordCount = Object.keys(snapshot.val()).length
          for (let i = 0; i < passwordCount; i++) {
            const userId = Object.keys(snapshot.val())[i]
            const passwordData = snapshot.val()[userId]

            if (localStorage.getItem('currentUserId') == passwordData.userId) {
              const accountElement = document.getElementById('account')

              const containerDiv = document.createElement('div')
              containerDiv.classList.add('col-12', 'd-flex')

              const accountDiv = document.createElement('div')
              accountDiv.classList.add('col-lg-4', 'col-sm-12', 'd-flex')
              const accountParagraph = document.createElement('p')
              accountParagraph.classList.add('mb-0', 'fs-6', 'me-2')
              accountParagraph.textContent = 'Account: '
              const accountDataParagraph = document.createElement('p')
              accountDataParagraph.classList.add('fs-6')
              accountDataParagraph.textContent = passwordData.email
              accountDiv.appendChild(accountParagraph)
              accountDiv.appendChild(accountDataParagraph)

              containerDiv.appendChild(accountDiv)

              accountElement.appendChild(containerDiv)

              const buttonElement = document.getElementById('show')

              const passwordDiv = document.createElement('div')
              passwordDiv.classList.add('col-12', 'd-flex')
              const passwordParagraph = document.createElement('p')
              passwordParagraph.classList.add('mb-0', 'fs-6', 'me-2')
              passwordParagraph.textContent = 'Password: '
              const passwordDataParagraph = document.createElement('button')
              passwordDataParagraph.classList.add('fs-6', 'border-0', 'bg-white')
              passwordDataParagraph.id = 'showPassword'
              passwordDataParagraph.textContent = 'Show password'
              passwordDiv.appendChild(passwordParagraph)
              passwordDiv.appendChild(passwordDataParagraph)

              buttonElement.appendChild(passwordDiv)
            }
          }
        } else {
          console.log("No data available")
        }
      })
      .catch((error) => {
        console.error("Error retrieving data:", error)
      })
  </script>
</body>

</html>